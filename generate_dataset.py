import sys
import os
import pandas as pd
import pickle
import numpy as np
from tqdm import tqdm
from pathlib import Path


if __name__ == '__main__':
    if len(sys.argv) != 2:
        print('Usage: train.py DATASET')
        sys.exit(1)

    dataset = sys.argv[1]
    base_path = Path(f'./data/code2vec/vectors/{dataset}')

    # Build the dataset
    files = base_path.glob('*.c2v.vectors')
    X = []
    y = []

    label_df = pd.read_csv(f'./data/processed/{dataset}/labels.csv')

    for file in tqdm(list(files)):
        number = int(file.name.split('.')[0][-5:])

        # Get the data
        with open(file, 'r') as f:
            line = f.readline()
            X.append([float(x) for x in line.split()])

        # Get the target
        y.append(label_df[label_df['Unnamed: 0'] == number]['target'])

    # Pickle the data
    with open(f'./data/code2vec/{dataset}.pickle', 'wb') as f:
        data = {'X': np.array(X), 'y': np.array(y)}
        pickle.dump(data, f)
